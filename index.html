<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=no">
<title>Synth</title>
<style>
  body {
    padding: 50px;
    font-family: sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background: #111;
    user-select: none;
  }

  .effect-buttons, .container {
    display: grid;
    grid-template-columns: repeat(4, auto);
    gap: 12px;
    justify-content: center;
  }

  .effect-buttons {
    grid-template-columns: repeat(4, auto);
    margin-bottom: 20px;
  }

  button {
    width: 80px;
    height: 80px;
    border: none;
    border-radius: 12px;
    background: #444;
    color: white;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
  }

  button.active {
    background: #2ecc71;
    transform: scale(0.95);
  }

  #soundContainer {
    margin-bottom: 20px;
    grid-template-columns: repeat(4, 80px);
  }

</style>
</head>
<body>

<div>
  <div class="container" id="soundContainer"></div>
  <div class="effect-buttons" id="effectButtons"></div>
  <div class="container" id="buttons"></div>
</div>

<script>
  const sounds = ["sine", "triangle", "square", "sawtooth"];
  const effects = ["reverb", "distortion", "tremolo", "lowpass"];

  const soundContainer = document.getElementById("soundContainer");
  const effectContainer = document.getElementById("effectButtons");

  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const convolver = audioCtx.createConvolver();

  // --- Reverb impulse response
  function createImpulseResponse(duration = 2, decay = 2) {
    const rate = audioCtx.sampleRate;
    const length = rate * duration;
    const impulse = audioCtx.createBuffer(2, length, rate);
    for (let i = 0; i < 2; i++) {
      const channelData = impulse.getChannelData(i);
      for (let j = 0; j < length; j++) {
        channelData[j] = (Math.random() * 2 - 1) * Math.pow(1 - j / length, decay);
      }
    }
    return impulse;
  }
  convolver.buffer = createImpulseResponse();

  // Track the currently active effect
  let activeEffect = "none";

  // Create effect toggle buttons
  effects.forEach(effect => {
    const btn = document.createElement('button');
    btn.textContent = effect;
    effectContainer.appendChild(btn);

    btn.addEventListener('pointerdown', () => {
      // Toggle logic: deactivate all others, activate this one if not already active
      if (activeEffect === effect) {
        activeEffect = "none";
        btn.classList.remove('active');
      } else {
        activeEffect = effect;
        [...effectContainer.children].forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      }
    });
  });

  // Create sound type buttons
  sounds.forEach(sound => {
    const btn = document.createElement('button');
    btn.textContent = sound;
    soundContainer.appendChild(btn);

    btn.addEventListener('pointerdown', () => {
      [...soundContainer.children].forEach(child => child.classList.remove('active'));
      localStorage.setItem('soundSelection', sound);
      btn.classList.add('active');
    });
  });

  const notes = [
  // Top row — Sharps/Flats
  { name: 'C♯', freq: 277.18, keystroke: 'w' },
  { name: 'D♯', freq: 311.13, keystroke: 'e' },
  { name: 'F♯', freq: 369.99, keystroke: 't' },
  { name: 'G♯', freq: 415.30, keystroke: 'y' },
  { name: 'A♯', freq: 466.16, keystroke: 'u' },
  { name: 'C♯′', freq: 554.37, keystroke: 'o' },
  { name: 'D♯′', freq: 622.25, keystroke: 'p' },

  // Middle row — Main C major scale (extends beyond one octave)
  { name: 'C',  freq: 261.63, keystroke: 'a' },
  { name: 'D',  freq: 293.66, keystroke: 's' },
  { name: 'E',  freq: 329.63, keystroke: 'd' },
  { name: 'F',  freq: 349.23, keystroke: 'f' },
  { name: 'G',  freq: 392.00, keystroke: 'g' },
  { name: 'A',  freq: 440.00, keystroke: 'h' },
  { name: 'B',  freq: 493.88, keystroke: 'j' },
  { name: 'C′', freq: 523.25, keystroke: 'k' },
  { name: 'D′', freq: 587.33, keystroke: 'l' },
  { name: "E′", freq: 659.26, keystroke: ';' },
  { name: "F′", freq: 698.46, keystroke: "'" },

  // Bottom row — Bass notes (one octave below)
  { name: 'C (bass)',  freq: 130.81, keystroke: 'x' },
  { name: 'D (bass)',  freq: 146.83, keystroke: 'c' },
  { name: 'E (bass)',  freq: 164.81, keystroke: 'v' },
  { name: 'F (bass)',  freq: 174.61, keystroke: 'b' },
  { name: 'G (bass)',  freq: 196.00, keystroke: 'n' },
  { name: 'A (bass)',  freq: 220.00, keystroke: 'm' },
  { name: 'B (bass)',  freq: 246.94, keystroke: ',' },
  { name: 'C′ (bass)', freq: 261.63, keystroke: '.' },
  { name: 'D′ (bass)', freq: 293.66, keystroke: '/' },
];

  const container = document.getElementById('buttons');
  const activeOscillators = new Map();

  function playNote(noteName, freq) {
    if (activeOscillators.has(noteName)) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = localStorage.getItem('soundSelection') || 'sine';
    osc.frequency.value = freq;
    let output = gain;

    // --- Effects
    if (activeEffect === 'reverb') {
      osc.connect(gain);
      gain.connect(convolver);
      convolver.connect(audioCtx.destination);
    }
    else if (activeEffect === 'distortion') {
      const distortion = audioCtx.createWaveShaper();
      const curve = new Float32Array(44100);
      for (let i = 0; i < 44100; i++) {
        const x = (i * 2) / 44100 - 1;
        curve[i] = Math.tanh(3 * x);
      }
      distortion.curve = curve;
      osc.connect(distortion);
      distortion.connect(gain);
      gain.connect(audioCtx.destination);
    }
    else if (activeEffect === 'tremolo') {
      const tremGain = audioCtx.createGain();
      const lfo = audioCtx.createOscillator();
      const depth = audioCtx.createGain();
      lfo.frequency.value = 5;
      depth.gain.value = 0.5;
      lfo.connect(depth).connect(tremGain.gain);
      lfo.start();
      osc.connect(tremGain);
      tremGain.connect(gain);
      gain.connect(audioCtx.destination);
    }
    else if (activeEffect === 'lowpass') {
      const filter = audioCtx.createBiquadFilter();
      filter.type = 'lowpass';
      filter.frequency.value = 800;
      osc.connect(filter);
      filter.connect(gain);
      gain.connect(audioCtx.destination);
    }
    else {
      osc.connect(gain);
      gain.connect(audioCtx.destination);
    }

    gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
    osc.start();
    activeOscillators.set(noteName, { osc, gain });
  }

  function stopNote(noteName, btn) {
    const data = activeOscillators.get(noteName);
    if (data) {
      const { osc, gain } = data;
      gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + 0.1);
      osc.stop(audioCtx.currentTime + 0.1);
      activeOscillators.delete(noteName);
      if (btn) btn.classList.remove('active');
    }
  }

  // --- Create note buttons ---
  notes.forEach(note => {
    const btn = document.createElement('button');
    btn.textContent = note.name;
    container.appendChild(btn);
    btn.addEventListener('pointerdown', () => { playNote(note.name, note.freq); btn.classList.add('active'); });
    btn.addEventListener('pointerup', () => stopNote(note.name, btn));
    btn.addEventListener('pointerleave', () => stopNote(note.name, btn));
    btn.addEventListener('pointercancel', () => stopNote(note.name, btn));

    document.addEventListener('keydown', e => {
      if (e.key === note.keystroke) { playNote(note.name, note.freq); btn.classList.add('active'); }
    });
    document.addEventListener('keyup', e => {
      if (e.key === note.keystroke) stopNote(note.name, btn);
    });
  });

  // resume audio context
  document.body.addEventListener('click', () => {
    if (audioCtx.state === 'suspended') audioCtx.resume();
  }, { once: true });
</script>
</body>
</html>
